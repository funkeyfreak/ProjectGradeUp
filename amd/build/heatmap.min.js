define(["block_projectgradeup/core","jquery","block_projectgradeup/artifact","core/log","block_projectgradeup/ajax",M.cfg.wwwroot+"/blocks/projectgradeup/externaljs/jquery-ui.min.js",M.cfg.wwwroot+"/blocks/projectgradeup/externaljs/raphael.js"],function(a,b,c,d,e,f){a=a.strings,d.debug(f),require([M.cfg.wwwroot+"/blocks/projectgradeup/externaljs/g.raphael-min.js"]);var g,h,i,j,k;heatMap={preHeatMap:!1,doHeatMap:function(c){if(d.debug("Loading Heatmap..."),b(a.heatmapPresentationDiv).empty(),"undefined"==typeof c)this.preHeatMap!==!1?b(a.semesterCheckBoxId).is(":checked")?loadMap(JSON.parse(JSON.parse(this.preHeatMap))[1]):loadMap(JSON.parse(JSON.parse(this.preHeatMap))[0]):(d.debug(a.invalidNoECall),b(a.heatmapPresentationDiv).html("<h3>"+a.invalidNoECall+"</h3>"));else{var e=JSON.parse(c);if(this.preHeatMap=c,e.hasOwnProperty("error"))d.debug(e.error),d.debug(e.stacktrace),b(a.heatmapPresentationDiv).html("<h3>"+e.debuginfo+"</h3>"),d.debug(e.debuginfo);else{d.debug("Parsing e");var f=JSON.parse(JSON.parse(c));this.res=this.typeCheckResolution(),b(a.semesterCheckBoxId).is(":checked ")?loadMap(f[1]):loadMap(f[0])}}},parseError:function(c){d.debug("Oh nose! An error was found in projectgradeup/heatmap.js::.click"),d.debug(c),b(a.presentationLoadingDiv).html("<h1>Sorry, teacher-student view is not ready, please log in as one of your students to view their charts</h1>")},typeCheckColorBlind:function(c){return"undefined"==typeof c?c=b(a.colorblindCheckBoxId).is(":checked"):"boolean"!=typeof colorblind&&(c=b(a.colorblindCheckBoxId).is(":checked")),c},typeCheckResolution:function(b){if("undefined"==typeof b)b={},b.width=0==document.getElementById(a.heatmapPresentationDivId).offsetWidth?1080:document.getElementById(a.heatmapPresentationDivId).offsetWidth,b.height=.25*b.width;else if("width"in b&&"height"in b){if(Array.isArray(b)&&2==b.length){var c;try{c=b.reduce(function(a,b,c){return a[c]=b,a},{}),b=c}catch(e){d.debug(e)}finally{b={},b.width=0==document.getElementById(a.heatmapPresentationDivId).offsetWidth?1080:document.getElementById(a.heatmapPresentationDivId).offsetWidth,b.height=.25*b.width}}}else b={},b.width=0==document.getElementById(a.heatmapPresentationDivId).offsetWidth?1080:document.getElementById(a.heatmapPresentationDivId).offsetWidth,b.height=.25*b.width;return b},res:{width:0,height:0}},loadMap=function(c){document.getElementById(a.heatmapPresentationDivId).hasChildNodes()&&b(a.heatmapPresentationDiv).empty();var e,f,l,m,n,o,p,q,r,s=JSON.parse(c),t=[],u=[],v=[],w=[];e=b(a.chartTypeCheckBoxId).is(":checked"),f=heatMap.typeCheckColorBlind(),m=f?"#333333":a.rectangleColor,g=document.getElementById(a.heatmapPresentationDivId),h=Raphael(g,heatMap.res.width,heatMap.res.height),i=h.set(),j=h.set(),k=h.set();var x=h.rect(0,0,heatMap.res.width,heatMap.res.height).attr({fill:m,"fill-opacity":a.opacityHalf,stroke:a.strokeNone});h.add(x),p=JSON.parse(s[1].annotations),w.push(JSON.parse(s[2].current)),o=w,n=JSON.parse(s[0].heatmap),n=n.split("|");for(var y=0;y<n.length;y++)t.push(JSON.parse(n[y]));q=JSON.parse(s[3].ticks),j=q,r=JSON.parse(s[4].triangles),e?h.add(t):h.add(r),l=h.add(o),l.hover(function(a){var b=this.getBBox();h.width/2>a.pageX?this.marker=this.marker||h.popup(b.x+.7*b.width+15,b.y+.3*b.height,this.node.textContent,"right",7).insertBefore(this):this.marker=this.marker||h.popup(b.x+.7*b.width-15,b.y+.3*b.height,this.node.textContent,"left",7).insertBefore(this),this.marker.show(),this.attr({opacity:1,"stroke-width":15})},function(a){this.marker&&this.marker.hide(),this.attr({opacity:.5,"stroke-width":0})});for(var y=0;y<p.length;y++)u.push(p[y].rect),v.push(p[y].name);i=h.add(u);for(var y=0;y<i.length;y++)i[y].node.setAttribute("value",v[y]);i.hover(function(a){var b=this.getBBox();h.width/2>a.pageX?this.marker=this.marker||h.popup(b.x+.7*b.width+15,b.y+.3*b.height,this.node.attributes.value.value,"right",7).insertBefore(this):this.marker=this.marker||h.popup(b.x+.7*b.width-15,b.y+.3*b.height,this.node.attributes.value.value,"left",7).insertBefore(this),this.marker.show(),this.attr({opacity:1,"stroke-width":15})},function(a){this.marker&&this.marker.hide(),this.attr({opacity:.15,"stroke-width":2})}),j=h.add(q),j.hover(function(a){var b=this.getBBox();h.width/2>a.pageX?this.marker=this.marker||h.popup(b.x+.7*b.width+5,b.y+.6*b.height,this.node.textContent,"right",7).insertBefore(this):this.marker=this.marker||h.popup(b.x+.7*b.width-5,b.y+.6*b.height,this.node.textContent,"left",7).insertBefore(this),this.marker.show(),this.attr({opacity:1,"stroke-width":3})},function(a){this.marker&&this.marker.hide(),this.attr({opacity:.15,"stroke-width":0})}),d.debug("Heatmap Complete")};var l=(heatMap.typeCheckResolution(),function(){var a=new e;a.createHeatmapRequest("single",function(a){heatMap.doHeatMap(a)},function(a){heatMap.parseError(a)})}),m=function(){l()};return{heatMap:heatMap,testerFunction:l,init:m}});