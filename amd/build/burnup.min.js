define(["block_projectgradeup/core","jquery","block_projectgradeup/artifact","core/log","block_projectgradeup/ajax",M.cfg.wwwroot+"/blocks/projectgradeup/externaljs/raphael.js"],function(a,b,c,d,e){a=a.strings,require([M.cfg.wwwroot+"/blocks/projectgradeup/externaljs/g.raphael-min.js"]);var f=function(a,b){this.artifactManager=a,this.artifactCollection=a.collection;var c=void 0==typeof b?this.typeCheckResolution(b):b;this.resolution=[],this.resolution[0]=c.width,this.resolution[1]=c.height,this.selectedArtifacts=[]};f.prototype=Object.create(f.prototype),f.prototype.constructor=f,f.prototype={createArtifacts:function(){var a=this.resolution,b=a[0],c=a[1],d=this.artifactCollection,e=[],f=[],g=[],h=[],i=[],j=[],k=[],l=0,m=c,n=0,o=c;this.selectedArtifacts=[];for(var p=0;p<d.length;p++)"notdue"!=d[p].status&&"notgraded"!=d[p].status&&(n=d[p].category*d[p].weight*b+l,o=d[p].category*d[p].weight*c*-1*d[p].grade+m,e.push([l,c]),f.push([n,c]),g.push([l,m]),h.push([n,o]),i.push(d[p].status),j.push(d[p].url),l=n,m=o,this.selectedArtifacts.push(d[p]));for(var p=0;p<d.length;p++)("notdue"==d[p].status||"notgraded"==d[p].status)&&(n=d[p].category*d[p].weight*b+l,o=d[p].category*d[p].weight*c*-1*1+m,e.push([l,c]),f.push([n,c]),g.push([l,m]),h.push([n,o]),i.push(d[p].status),j.push(d[p].url),l=n,m=o,this.selectedArtifacts.push(d[p]));for(var p=0;p<e.length;p++)k.push([e[p],g[p],h[p],f[p],e[p],i[p],j[p]]);return k},createTrendLine:function(){for(var a=this.resolution,b=a[0],c=a[1],d=this.artifactCollection,e=[],f=[],g=0,h=c,i=0,j=c,k=[],l=0;l<d.length;l++)"notdue"!=d[l].status&&"notgraded"!=d[l].status&&(i=d[l].category*d[l].weight*b+g,j=d[l].category*d[l].weight*c*-1*d[l].grade+h,e.push([g,h]),f.push([i,j]),g=i,h=j);for(var l=0;l<e.length;l++)k.push(e[l]);return k.push([g,h]),k},createGradeRanges:function(){var a=this.resolution,b=a[0],c=a[1],d=[[0,c],[b,0*c],[b,.1*c],[0,c]],e=[[0,c],[b,.1*c],[b,.2*c],[0,c]],f=[[0,c],[b,.2*c],[b,.3*c],[0,c]],g=[[0,c],[b,.3*c],[b,.4*c],[0,c]];return[d,e,f,g]},createProjections:function(a){for(var b=this.resolution,c=b[0],d=b[1],e=this.artifactCollection,f=[],g=[],h=0,i=d,j=0,k=d,l=0;l<e.length&&("notdue"==e[l].status||"notgraded"==e[l].status||(j=e[l].category*e[l].weight*c+h,k=e[l].category*e[l].weight*d*-1*e[l].grade+i,f.push(h),g.push(i),h=j,i=k,l!==e.length));l++);var m=(i-d)/h,n=m*(c-h)+i,o=(d-0)/(0-c),p=[[h,i],[c,o*(c-h)+i]],q=[[h,i],[c,i]],r=[[h,i],[c,n]];return"undefined"!=typeof a?[p,q,r,a]:[p,q,r]},createCompletedArea:function(){for(var a=this.resolution,b=a[0],c=a[1],d=this.artifactCollection,e=0,f=c,g=0,h=c,i=[],j=0;j<d.length;j++)"notdue"!=d[j].status&&"notgraded"!=d[j].status&&(g=d[j].category*d[j].weight*b+e,h=d[j].category*d[j].weight*c*-1*d[j].grade+f,i.push([e,f]),e=g,f=h);return i.push([0,b]),i},produceCompleteArray:function(){d.debug("Started...");for(var a,b=[],c=[],e=[],f=[],g=[],h=[],i=this.createArtifacts(),j=0;j<i.length;j++)b.push("M "+i[j][0].join()+" L "+i[j][1].join()+" L "+i[j][2].join()+" L "+i[j][3].join()+" L "+i[j][4].join());d.debug("Created Artifacts...");for(var k=this.createTrendLine(),j=0;j<k.length;j++)0!=j?c.push(" L "+k[j].join()):c.push("M "+k[j].join());d.debug("Created Trend Lines...");for(var l=this.createGradeRanges(),j=0;j<l.length;j++)e.push("M "+l[j][0].join()+" L "+l[j][1].join()+" L "+l[j][2].join()+" L "+l[j][3].join());d.debug("Created Areas...");var m=this.createCompletedArea();f.push("M "+m[0].join());for(var j=0;j<m.length;j++)0!=j&&f.push(" L "+m[j].join());d.debug("Created Current Area...");for(var n=this.createProjections(),j=0;j<n.length;j++)g.push("M "+n[j][0].join()+" L "+n[j][1].join());d.debug("Created Projections...");for(var o=[],j=0;j<b.length;j++){var p=i[j];"notdue"===p[5]?o.push({type:"path",path:b[j],opacity:.5,"stroke-width":1}):"incomplete"===p[5]||"incompleted"===p[5]?o.push({type:"path",path:b[j],fill:"#ca102c",opacity:1,"stroke-width":1}):"complete"===p[5]||"completed"===p[5]?o.push({type:"path",path:b[j],fill:"#323232",opacity:1,"stroke-width":1}):"notgraded"===p[5]?o.push({type:"path",path:b[j],opacity:.5,"stroke-width":1}):"notgradedshow"===p[5]?o.push({type:"path",path:b[j],fill:"#fff80b",opacity:1,"stroke-width":1}):"notdueshow"===p[5]?o.push({type:"path",path:b[j],fill:"#aff80b",opacity:1,"stroke-width":1}):o.push({type:"path",path:b[j],fill:"#af1ff8",opacity:1,"stroke-width":1})}a=JSON.stringify(o),h.push(JSON.stringify({ArtifactsJSON:a})),d.debug("Artifact Production Completed"),o=[],o.push({type:"path",path:e[0],fill:"#81c4ff",opacity:.5,stroke:"none"}),o.push({type:"path",path:e[1],fill:"#82ffab",opacity:.5,stroke:"none"}),o.push({type:"path",path:e[2],fill:"#ffbf48",opacity:.5,stroke:"none"}),o.push({type:"path",path:e[3],fill:"#ff4600",opacity:.5,stroke:"none"}),a=JSON.stringify(o),h.push(JSON.stringify({GradesJSON:a})),d.debug("Grade Regions Production Completed"),o=[],o.push({type:"path",path:c.join(" "),stroke:"#333333","stroke-width":5}),a=JSON.stringify(o),h.push(JSON.stringify({GradeTrendJSON:a})),d.debug("Grade Trends Production Completed"),o=[],o.push({type:"path",path:g[0],"stroke-width":3,stroke:"#5aa7bb"}),o.push({type:"path",path:g[1],"stroke-width":3,stroke:"#a32d24"}),o.push({type:"path",path:g[2],"stroke-width":3,stroke:"#a32df4"}),a=JSON.stringify(o),h.push(JSON.stringify({ProjectionJSON:a})),d.debug("Projections Production Completed"),o=[],o.push({type:"path",path:f.join(" "),"stroke-width":3,opacity:.5}),a=JSON.stringify(o),h.push(JSON.stringify({CompletedArea:a})),d.debug("Area Production Completed"),o=[];var q=this.getTitle();o.push(q),a=JSON.stringify(q),o=[],h.push(JSON.stringify({Title:a}));var r=this.getProjectionGrades(n);o.push(r),a=JSON.stringify(r),h.push(JSON.stringify({ProjLabels:a})),d.debug("Labels Production Completed");var s=JSON.stringify(h);return s},typeCheckResolution:function(b){if("undefined"==typeof b)b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width;else if("width"in b&&"height"in b){if(Array.isArray(b)&&2==b.length){var c;try{c=b.reduce(function(a,b,c){return a[c]=b,a},{}),b=c}catch(e){d.debug(e)}finally{b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width}}}else b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width;return b},typeCheckColorBlind:function(c){return"undefined"==typeof c?c=b(a.colorblindCheckBoxId).is(":checked"):"boolean"!=typeof colorblind&&(c=b(a.colorblindCheckBoxId).is(":checked")),c?1:0},getTitle:function(){for(var a=this.selectedArtifacts,b=[],c=0;c<a.length;c++)b.push({title:a[c].title,grade:a[c].grade,index:c});return b},getProjectionGrades:function(a){var b=a,c=this.resolution,d=c[1],e=[];return e.push({title:"Best Possible",grade:-100*(b[0][1][1]/d-1)}),e.push({title:"Worst Posssible",grade:-100*(b[1][1][1]/d-1)}),e.push({title:"Current Projection",grade:-100*(b[2][1][1]/d-1)}),4==e.length&&e.push({title:"Class Average",grade:-100*(b[3][1][1]/d-1)}),e}};var g,h,i,j,k,l,m,n,o,p,q,r,s;burnup={res:{width:0,height:0},artifactCollection:null,parseError:function(c){debug.log("Oh nose! An error was found in projectgradeup/burnup.js::getData"),debug.log(c),b(a.presentationLoadingDiv).html("<h1>Sorry, teacher-student view is not ready, please log in as one of your students to view their charts</h1>")},typeCheckResolution:function(b){if("undefined"==typeof b)b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width;else if("width"in b&&"height"in b){if(Array.isArray(b)&&2==b.length){var c;try{c=b.reduce(function(a,b,c){return a[c]=b,a},{}),b=c}catch(e){d.debug(e)}finally{b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width}}}else b={},b.width=0==document.getElementById(a.burnupPresentationDivId).offsetWidth?1080:document.getElementById(a.burnupPresentationDivId).offsetWidth,b.height=2/3*b.width;return b},doBurnup:function(c){d.debug("Loading Burnup..."),b(a.burnupPresentationDiv).empty();var e=JSON.parse(c);if(e.hasOwnProperty("error"))d.debug(e.error),d.debug(e.stacktrace),b(a.burnupPresentationDiv).html("<h3>"+e.debuginfo+"</h3>"),d.debug(e.debuginfo);else{this.res=this.typeCheckResolution(),d.debug("Creating Burnup");var f=JSON.parse(c);loadGraph(f)}},doPureBurnup:function(e){d.debug("Loading Burnup..."),b(a.burnupPresentationDiv).empty();var g=JSON.parse(e);if(g.hasOwnProperty("error"))d.debug(g.error),d.debug(g.stacktrace),b(a.burnupPresentationDiv).html("<h3>"+g.debuginfo+"</h3>"),d.debug(g.debuginfo);else{this.res=this.typeCheckResolution(),this.artifactCollection=new c(e),this.artifactCollection=this.artifactCollection;var h=new f(this.artifactCollection,this.res),i=h.produceCompleteArray();d.debug("Creating Burnup!"),loadGraph(i)}},refreshBurnup:function(){d.debug("Loading Burnup..."),b(a.burnupPresentationDiv).empty();var c=new f(this.artifactCollection,this.res),e=c.produceCompleteArray();d.debug("Creating Burnup!"),loadGraph(e)},setAllDivAttr:function(b,c,d){for(var e="undefined"==typeof d?a.contextMenuDefultDivId:d,f=0;f<b.length;f++)b[f].node.setAttribute("class",e+"."+f),b[f].node.setAttribute("value",c[f].title),b[f].node.setAttribute("id",c[f].index)},setOneDivAttr:function(b,c,d,e){var f=void 0===c?a.contextMenuDefultDivId:c;b.node.setAttribute("class",f),"undefined"!=typeof d&&b.node.setAttribute("id",d),"undefined"!=typeof d&&b.node.setAttribute("value",e)},getPorjectionsData:function(a,b){for(var c={},d=0;d<a.length;d++){var e=a[d].id.toString();c[e]=b[d]}return c},getArtifactsData:function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d].id.toString();c[e]=b[d]}return c},getLowestProjectionGrade:function(a,b){for(var c=Number.MAX_SAFE_INTEGER,d=0;d<a.length;d++)b[d].grade<c&&(c=b[d].grade);return c},openInNewTab:function(a){var b=window.open(a,"_blank");b.focus()}};var t={hoverHandler:function(a){i.forEach(function(a){s=a.getBBox(),Raphael.isPointInsideBBox(s,p,q)?t.inMouse(a):t.outMouse(a)})},inMouse:function(b){hoverAnimation=Raphael.animation({fill:a.artifactColorOnHover,opacity:a.opacityFull},a.hoverAnimationWait),b.animate(hoverAnimation.delay(a.hoverAnimationDelay))},outMouse:function(b){hoverAnimation=Raphael.animation({opacity:a.opacityNone},a.hoverAnimationWait),b.animate(hoverAnimation.delay(a.hoverAnimationDelay))}};b.fn.exists=function(){return this.length>0},loadGraph=function(c){b(a.presentationLoadingDiv).exists()&&b(a.presentationLoadingDiv).remove();var d,e,f,s,u,v,w,x,y,z=[];({windowHeight:window.screen.height,windowWidth:window.screen.depth});g=document.getElementById(a.burnupPresentationDivId),h=Raphael(g,burnup.res.width,burnup.res.height),i=h.set(),j=h.set(),k=h.set(),l=h.set(),m=h.set(),n=h.set(),o=h.set();var A=h.rect(0,0,burnup.res.width,burnup.res.height).attr({fill:a.rectangleColor,"fill-opacity":a.opacityHalf,stroke:a.strokeNone}),B=!0,C=0,D=2;for(h.add(A),d=h.add(JSON.parse(JSON.parse(JSON.parse(c)[0]).ArtifactsJSON)),e=h.add(JSON.parse(JSON.parse(JSON.parse(c)[1]).GradesJSON)),f=h.add(JSON.parse(JSON.parse(JSON.parse(c)[2]).GradeTrendJSON)),s=h.add(JSON.parse(JSON.parse(JSON.parse(c)[3]).ProjectionJSON)),i=d.clone(),k=e.clone(),k.push(f.clone()),n=d.clone(),m=s.clone(),u=JSON.parse(JSON.parse(JSON.parse(c)[5]).Title),v=JSON.parse(JSON.parse(JSON.parse(c)[6]).ProjLabels),w=burnup.getArtifactsData(n,u),x=burnup.getPorjectionsData(m,v),y=burnup.getLowestProjectionGrade(m,v),burnup.setAllDivAttr(n,u),n.attr({fill:a.artifactColorInBBox,stroke:a.strokeInBBox,"stroke-width":1,opacity:.3}).hover(function(b){r=this.getBBox(),h.width/2>b.pageX?this.marker=this.marker||h.popup(r.x+.5*r.width,r.y+.3*r.height,w[this.id.toString()].title+a.hoverMessageGrade+100*w[this.id.toString()].grade.toFixed(2)+"%","right",5).insertBefore(this):this.marker=this.marker||h.popup(r.x+.5*r.width,r.y+.3*r.height,w[this.id.toString()].title+a.hoverMessageGrade+100*w[this.id.toString()].grade.toFixed(2)+"%","left",5).insertBefore(this),this.marker.show(),t.hoverHandler(b)},function(c){this.marker&&this.marker.hide(),p=c.pageX-b(document).scrollLeft()-b(a.burnupPresentationDiv).offset().left,q=c.pageY-b(document).scrollTop()-b(a.burnupPresentationDiv).offset().top,t.hoverHandler(c)}).mousedown(function(c){if(3==c.which){a.presentationLoadingDivId=this.node.id,b(a.burnupPopupDiv).dialog("open")}}),m.hover(function(c){r=this.getBBox();var d=b(a.burnupPresentationDiv).offset(),e=c.pageX-d.left,f=c.pageY-d.top;this.attr({"stroke-width":10}),this.marker=h.popup(e-r.width,f,x[this.id.toString()].title+" : "+x[this.id.toString()].grade.toFixed(2),"left",5).insertBefore(this),this.marker.show()},function(a){this.attr({"stroke-width":3}),this.marker&&this.marker.hide()});B&&(z=.5>C?h.path("M"+.89*burnup.res.width+","+burnup.res.height*C+"L"+burnup.res.width+","+burnup.res.height*C).attr({strioke:"0DF0FD","stroke-width":D,title:100*(1-C)}):.7>C?h.path("M"+.95*burnup.res.width+","+burnup.res.height*C+"L"+burnup.res.width+","+burnup.res.height*C).attr({strioke:"0DF0FD","stroke-width":D,title:100*(1-C)}):h.path("M"+.97*burnup.res.width+","+burnup.res.height*C+"L"+burnup.res.width+","+burnup.res.height*C).attr({strioke:"0DF0FD","stroke-width":D,title:100*(1-C)}),C+=.1,o.push(z),!(C>=1)););for(C=0;1>C;)0==C?h.text(h.width-.015*h.width*5,h.height-.015*h.height*2,C+"%").attr({"font-size":.015*h.width+"px","font-weight":"800",fill:"grey",stroke:"black","stroke-width":.0015*h.width+"px","text-anchor":"start"}):h.text(h.width-.015*h.width*5,h.height-h.height*C-.015*h.height*2,Math.round(100*C)+"%").attr({"font-size":.015*h.width+"px","font-weight":"800",fill:"grey",stroke:"black","stroke-width":.0015*h.width+"px","text-anchor":"start"}),C+=.1;o.hover(function(c){r=this.getBBox();var d=b(a.burnupPresentationDiv).offset(),e=c.pageX-d.left,f=c.pageY-d.top;this.attr({"stroke-width":10}),this.marker=h.popup(e-r.width,f,parseInt(this.node.textContent)+"%","left",5).insertBefore(this),this.marker.show()},function(a){this.attr({"stroke-width":2}),this.marker&&this.marker.hide()})},document.oncontextmenu=function(){return!1};var u=function(){var a=new e;a.createArtifactRequest("single",function(a){burnup.doPureBurnup(a)},function(a){heatMap.parseError(a)})},v=function(){u()};return{bunrup:burnup,testerfunction:u,init:v}});